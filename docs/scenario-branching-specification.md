# シナリオ分岐方式 仕様書

<!--
================================================================================
CrossBot Scenario Branching Specification
================================================================================
このドキュメントはCrossBotにおけるシナリオ分岐方式の仕様書です。
受講者・管理者・派遣会社など異なるユーザー種別に対して
どのようにシナリオを分岐させるかの設計を記載しています。

作成日: 2025-12-05
最終更新: 2025-12-09

【実装状況】
- 方式A（ロールベース）: 実装済み（targetRoleフィールド追加）
- 方式B（統一シナリオ）: シナリオエディタで設定可能
- 方式C（ハイブリッド）: 未実装（必要に応じて追加可能）

【推奨】
運用の簡便さから方式Bを推奨しています。
================================================================================
-->

## 概要

CrossBotチャットボットにおける受講者・管理者向けシナリオの分岐方式についての比較検討資料。

---

## 方式比較

### 方式A: ロールベース自動切り替え方式（実装済み）

**概要**: LMSから取得したユーザーロールに基づいて、自動的に適切なシナリオを表示

```
┌─────────────────────────────────────────────────────┐
│  LMSテナントサイト                                    │
│  ┌─────────────────────────────────────────────────┐│
│  │ チャットボット起動                                ││
│  │      │                                          ││
│  │      ▼                                          ││
│  │ ┌─────────────┐                                 ││
│  │ │ロール判定    │                                 ││
│  │ └─────┬───────┘                                 ││
│  │       │                                          ││
│  │   ┌───┴───┬───────────┐                         ││
│  │   ▼       ▼           ▼                         ││
│  │ 受講者  グループ管理者  全体管理者                 ││
│  │ シナリオ シナリオ      シナリオ                   ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

#### メリット
- ユーザーは選択不要で適切なシナリオが表示される
- 管理者専用の問い合わせ内容が受講者に見えない
- ロールごとに完全に異なるシナリオを設計可能

#### デメリット
- LMS連携が必須（ロール情報の受け渡しが必要）
- シナリオを複数作成・管理する必要がある
- 管理者が受講者向けシナリオを確認しにくい

#### 実装状況
- Scenarioモデルに`targetRole`フィールド追加済み
- API・Widget・管理画面すべて対応済み

---

### 方式B: 統一シナリオ方式（推奨）

**概要**: 全ユーザー共通のシナリオで開始し、初期選択肢で分岐

```
┌─────────────────────────────────────────────────────┐
│  チャットボット起動                                   │
│           │                                          │
│           ▼                                          │
│  ┌─────────────────────────────────────────────────┐│
│  │ 「何についてお問い合わせですか？」                 ││
│  │                                                   ││
│  │  ┌────────────────────┐                          ││
│  │  │ 📚 受講について      │  ← 目立つボタン          ││
│  │  └────────────────────┘                          ││
│  │  ┌────────────────────┐                          ││
│  │  │ 💼 受講管理について  │  ← 目立つボタン          ││
│  │  └────────────────────┘                          ││
│  │                                                   ││
│  │  ┌────────────────────┐                          ││
│  │  │ 🏢 派遣会社様        │  ← 控えめなリンク        ││
│  │  └────────────────────┘                          ││
│  └─────────────────────────────────────────────────┘│
│           │                                          │
│     ┌─────┴─────┬─────────────┐                      │
│     ▼           ▼             ▼                      │
│  受講者向け   管理者向け    派遣会社向け              │
│  シナリオ     シナリオ      シナリオ                  │
└─────────────────────────────────────────────────────┘
```

#### メリット
- LMS連携不要（ロール情報なしでも動作）
- 1つのシナリオで管理が簡単
- ユーザーが自分で選択するため柔軟
- 管理者も受講者向けフローを確認可能
- 「派遣会社様」のような第三者向け導線も追加しやすい

#### デメリット
- ユーザーが間違った選択肢を選ぶ可能性
- 初期画面に複数の選択肢が表示される

#### 実装方法
既存のシナリオエディタで実現可能：
1. 開始ノードから複数の選択肢ノードを接続
2. 各選択肢から対象者別のフローに分岐
3. 派遣会社向けは小さめのテキストリンクとして表示

---

### 方式C: ハイブリッド方式

**概要**: ロール情報がある場合は自動切り替え、ない場合は選択式

```
┌─────────────────────────────────────────────────────┐
│  チャットボット起動                                   │
│           │                                          │
│           ▼                                          │
│  ┌─────────────────────────────────────────────────┐│
│  │ ロール情報あり？                                  ││
│  └─────────┬───────────────────────┬───────────────┘│
│            │ YES                   │ NO             │
│            ▼                       ▼                 │
│    ロール別シナリオ          統一シナリオ             │
│    自動表示                 （選択式）               │
└─────────────────────────────────────────────────────┘
```

#### メリット
- 最も柔軟な対応が可能
- LMS連携あり・なし両方に対応

#### デメリット
- 実装・テストが複雑
- 動作パターンが増えて管理が煩雑

---

## 推奨方式

### **方式B: 統一シナリオ方式** を推奨

#### 理由

1. **運用の簡便さ**
   - 1つのシナリオで全ユーザー対応
   - シナリオ更新時も1箇所の修正で済む

2. **LMS連携の不要**
   - ロール情報の受け渡しが不要
   - 埋め込み設定がシンプル

3. **柔軟な導線設計**
   - 「派遣会社様」など第三者向け導線を自然に追加可能
   - 将来的な拡張も容易

4. **ユーザー体験**
   - 受講者が多数派の場合、「受講について」を一番上に配置
   - 管理者向けは2番目、派遣会社向けは控えめに配置
   - 視覚的な優先順位でスムーズな誘導が可能

---

## 方式B 実装例

### シナリオ構造

```
開始ノード
├── 選択肢1: 📚 受講について（受講者向け）
│   └── 受講者向けフロー...
├── 選択肢2: 💼 受講管理について（管理者向け）
│   └── 管理者向けフロー...
└── 選択肢3: 🏢 派遣会社からのお問い合わせ（控えめ表示）
    └── 派遣会社向けフロー...
```

### UI表示例

```
┌────────────────────────────────────────┐
│  こんにちは！                           │
│  どのようなお問い合わせでしょうか？       │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │ 📚 受講について                    │  │  ← 大きめボタン
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │ 💼 受講管理について               │  │  ← 大きめボタン
│  └──────────────────────────────────┘  │
│                                         │
│  🏢 派遣会社からのお問い合わせはこちら    │  ← 小さめテキストリンク
└────────────────────────────────────────┘
```

---

## 既存実装との互換性

方式Aの実装（targetRoleフィールド）は保持されているため、
将来的にロールベース方式が必要になった場合も対応可能。

両方式は共存でき、運用状況に応じて切り替えられる。

---

## 補足: 派遣会社向け導線のデザイン案

「控えめだが見つけやすい」表示の実装案：

1. **小さいテキストリンク**: フォントサイズを小さく、色を薄めに
2. **区切り線で分離**: メイン選択肢と視覚的に分ける
3. **アイコン付き**: 🏢 などで識別しやすく
4. **位置**: 最下部に配置

---

## 作成日

2025年12月5日

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-05 | 初版作成 |
